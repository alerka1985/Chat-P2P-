<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat P2P Anónimo</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        #chat-ui, #guest-ui { display: none; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        #messages { height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; }
        #share-buttons { margin: 10px 0; }
        .share-btn { background: #25D366; color: white; border: none; padding: 8px 12px; margin-right: 5px; border-radius: 5px; cursor: pointer; }
        .share-btn.fb { background: #3b5998; }
    </style>
</head>
<body>
    <!-- Interfaz de inicio -->
    <div id="login">
        <h1>Chat P2P Anónimo</h1>
        <button onclick="createRoom()">Crear Sala (Admin)</button>
        <div id="join-section" style="margin-top: 10px;">
            <input type="text" id="room-code" placeholder="Código de sala">
            <button onclick="joinRoom()">Unirse</button>
        </div>
    </div>

    <!-- Interfaz del admin -->
    <div id="chat-ui">
        <h2>Sala: <span id="current-room"></span></h2>
        <div id="share-buttons">
            <button class="share-btn" onclick="shareOnWhatsApp()">WhatsApp</button>
            <button class="share-btn fb" onclick="shareOnFacebook()">Facebook</button>
        </div>
        <div id="messages"></div>
        <input type="text" id="message-input" placeholder="Escribe tu mensaje">
        <button onclick="sendMessage()">Enviar</button>
    </div>

    <!-- Interfaz del invitado -->
    <div id="guest-ui">
        <h2>Invitado a sala: <span id="guest-room-code"></span></h2>
        <button onclick="startGuestChat()">Iniciar Chat</button>
    </div>

    <script>
        // Configuración WebRTC
        const config = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };
        let peerConnection, dataChannel, roomCode, isAdmin = false;

        // 1. Admin: Crear sala
        async function createRoom() {
            isAdmin = true;
            roomCode = Math.random().toString(36).substring(2, 7).toUpperCase();
            document.getElementById("current-room").textContent = roomCode;
            document.getElementById("login").style.display = "none";
            document.getElementById("chat-ui").style.display = "block";
            
            peerConnection = new RTCPeerConnection(config);
            dataChannel = peerConnection.createDataChannel("chat");
            
            dataChannel.onmessage = (event) => {
                addMessage("Invitado", event.data);
            };

            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
        }

        // 2. Compartir en redes
        function shareOnWhatsApp() {
            const offer = JSON.stringify(peerConnection.localDescription);
            const url = `${window.location.href.split('?')[0]}?code=${roomCode}&offer=${encodeURIComponent(offer)}`;
            const text = `Únete a mi chat P2P! Código: ${roomCode}\n${url}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
        }

        function shareOnFacebook() {
            const offer = JSON.stringify(peerConnection.localDescription);
            const url = `${window.location.href.split('?')[0]}?code=${roomCode}&offer=${encodeURIComponent(offer)}`;
            window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`, '_blank');
        }

        // 3. Invitado: Iniciar chat
        async function startGuestChat() {
            const urlParams = new URLSearchParams(window.location.search);
            const offer = urlParams.get('offer');
            
            if (!offer) return;
            
            peerConnection = new RTCPeerConnection(config);
            
            peerConnection.ondatachannel = (event) => {
                dataChannel = event.channel;
                dataChannel.onmessage = (event) => {
                    addMessage("Admin", event.data);
                };
            };

            await peerConnection.setRemoteDescription(JSON.parse(decodeURIComponent(offer)));
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            
            document.getElementById("guest-ui").style.display = "none";
            document.getElementById("chat-ui").style.display = "block";
            document.getElementById("current-room").textContent = roomCode;
        }

        // 4. Auto-detectar invitado
        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('offer')) {
                roomCode = urlParams.get('code');
                document.getElementById("guest-room-code").textContent = roomCode;
                document.getElementById("login").style.display = "none";
                document.getElementById("guest-ui").style.display = "block";
            }
        };

        // Helpers
        function addMessage(sender, text) {
            const messagesDiv = document.getElementById("messages");
            messagesDiv.innerHTML += `<div><strong>${sender}:</strong> ${text}</div>`;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function sendMessage() {
            const message = document.getElementById("message-input").value;
            if (message && dataChannel) {
                dataChannel.send(message);
                addMessage(isAdmin ? "Tú (Admin)" : "Tú", message);
                document.getElementById("message-input").value = "";
            }
        }
    </script>
</body>
    </html>
