<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat P2P Directo</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; }
        #login, #chat-ui, #guest-waiting { display: none; }
        #login { display: block; }
        #messages { height: 300px; border: 1px solid #ddd; overflow-y: auto; padding: 10px; margin: 10px 0; }
        .btn { padding: 8px 15px; background: #4CAF50; color: white; border: none; border-radius: 4px; margin: 5px; }
        .share-link { width: 100%; padding: 8px; margin: 5px 0; }
    </style>
</head>
<body>
    <!-- Pantalla de inicio -->
    <div id="login">
        <h1>Chat P2P Directo</h1>
        <button class="btn" onclick="startAsAdmin()">Crear Chat</button>
        <div style="margin: 15px 0; text-align: center;">ó</div>
        <input type="text" id="room-code" placeholder="Código de chat" style="padding: 8px; width: 100%;">
        <button class="btn" onclick="joinAsGuest()">Unirse</button>
    </div>

    <!-- Pantalla de admin -->
    <div id="chat-ui">
        <h2>Chat: <span id="room-name"></span></h2>
        <div id="share-section">
            <input type="text" id="share-url" class="share-link" readonly>
            <button class="btn" onclick="copyShareLink()">Copiar Enlace</button>
            <button class="btn" style="background: #25D366;" onclick="shareWhatsApp()">WhatsApp</button>
            <button class="btn" style="background: #1877F2;" onclick="shareFacebook()">Facebook</button>
        </div>
        <div id="messages"></div>
        <input type="text" id="message-input" placeholder="Escribe tu mensaje" style="padding: 8px; width: 100%;">
        <button class="btn" onclick="sendMessage()">Enviar</button>
    </div>

    <!-- Pantalla de invitado esperando -->
    <div id="guest-waiting">
        <h2>Uniéndose a: <span id="guest-room"></span></h2>
        <p>Esperando conexión con el admin...</p>
    </div>

    <script>
        // Configuración WebRTC
        const config = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };
        let peerConnection, dataChannel, roomCode, isAdmin = false;

        // Admin: Crear nueva sala
        async function startAsAdmin() {
            isAdmin = true;
            roomCode = Math.random().toString(36).substring(2, 6).toUpperCase();
            
            // Configurar conexión
            peerConnection = new RTCPeerConnection(config);
            dataChannel = peerConnection.createDataChannel("chat");
            
            dataChannel.onmessage = (event) => {
                addMessage("Invitado", event.data);
            };

            // Mostrar interfaz
            document.getElementById('login').style.display = 'none';
            document.getElementById('chat-ui').style.display = 'block';
            document.getElementById('room-name').textContent = roomCode;
            
            // Generar enlace compartible
            const shareUrl = `${window.location.href.split('?')[0]}?room=${roomCode}`;
            document.getElementById('share-url').value = shareUrl;
            
            // Solo para demo - en producción necesitarías un servidor de signaling
            alert("COMPARTE ESTE ENLACE:\n" + shareUrl + "\n\nY este código de conexión:\n" + roomCode);
        }

        // Invitado: Unirse a sala
        async function joinAsGuest() {
            roomCode = document.getElementById('room-code').value.toUpperCase();
            if (!roomCode) return alert("Ingresa un código válido");
            
            // Mostrar pantalla de espera
            document.getElementById('login').style.display = 'none';
            document.getElementById('guest-waiting').style.display = 'block';
            document.getElementById('guest-room').textContent = roomCode;
            
            // Aquí normalmente conectarías via WebRTC
            // Por ahora simulamos conexión después de 2 segundos
            setTimeout(() => {
                document.getElementById('guest-waiting').style.display = 'none';
                document.getElementById('chat-ui').style.display = 'block';
                document.getElementById('room-name').textContent = roomCode;
                addSystemMessage("Conectado al chat. ¡Ya puedes escribir!");
            }, 2000);
        }

        // Funciones de UI
        function copyShareLink() {
            const shareInput = document.getElementById('share-url');
            shareInput.select();
            document.execCommand('copy');
            alert("Enlace copiado: " + shareInput.value);
        }

        function shareWhatsApp() {
            const url = document.getElementById('share-url').value;
            window.open(`https://wa.me/?text=${encodeURIComponent("Únete a mi chat: " + url)}`);
        }

        function shareFacebook() {
            const url = document.getElementById('share-url').value;
            window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`);
        }

        function sendMessage() {
            const message = document.getElementById('message-input').value;
            if (message) {
                addMessage(isAdmin ? "Tú (Admin)" : "Tú", message);
                document.getElementById('message-input').value = '';
                
                // En una implementación real, esto enviaría el mensaje via WebRTC
                if (dataChannel && dataChannel.readyState === 'open') {
                    dataChannel.send(message);
                }
            }
        }

        function addMessage(sender, text) {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML += `<p><strong>${sender}:</strong> ${text}</p>`;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function addSystemMessage(text) {
            addMessage("Sistema", text);
        }

        // Auto-detectar si viene de un enlace compartido
        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('room')) {
                roomCode = urlParams.get('room');
                document.getElementById('room-code').value = roomCode;
            }
        };
    </script>
</body>
</html>
