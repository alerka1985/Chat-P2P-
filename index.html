<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat P2P Anónimo</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        #chat-ui { display: none; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        #messages { height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; }
        #file-input { display: none; }
        .message { margin: 5px 0; padding: 8px; border-radius: 5px; background: #e3f2fd; }
        .admin-message { background: #ffecb3; }
    </style>
</head>
<body>
    <!-- Interfaz de inicio -->
    <div id="login">
        <h1>Chat P2P Anónimo</h1>
        <button onclick="createRoom()">Crear Sala (Admin)</button>
        <div id="join-section" style="margin-top: 10px;">
            <input type="text" id="room-code" placeholder="Código de sala">
            <button onclick="joinRoom()">Unirse</button>
        </div>
    </div>

    <!-- Interfaz del chat -->
    <div id="chat-ui">
        <h2>Sala: <span id="current-room"></span></h2>
        <div id="user-list"></div>
        <div id="messages"></div>
        <input type="text" id="message-input" placeholder="Escribe tu mensaje">
        <button onclick="sendMessage()">Enviar</button>
        <button onclick="shareFile()">Enviar Archivo</button>
        <input type="file" id="file-input">
    </div>

    <script>
        // Configuración WebRTC (STUN público de Google)
        const config = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };
        let peerConnection, dataChannel, roomCode, isAdmin = false;

        // 1. Admin: Crear sala
        async function createRoom() {
            isAdmin = true;
            roomCode = Math.random().toString(36).substring(2, 7).toUpperCase();
            document.getElementById("current-room").textContent = roomCode;
            document.getElementById("login").style.display = "none";
            document.getElementById("chat-ui").style.display = "block";
            
            peerConnection = new RTCPeerConnection(config);
            dataChannel = peerConnection.createDataChannel("chat");
            
            dataChannel.onmessage = (event) => {
                addMessage("Invitado", event.data);
            };

            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            
            // Guardar oferta para compartirla
            const offerString = JSON.stringify(offer);
            prompt("Comparte este código con los invitados:", `${window.location.href}?code=${roomCode}&offer=${encodeURIComponent(offerString)}`);
        }

        // 2. Invitado: Unirse a sala
        async function joinRoom() {
            roomCode = document.getElementById("room-code").value;
            const urlParams = new URLSearchParams(window.location.search);
            const offer = urlParams.get('offer');
            
            if (!offer) {
                alert("¡Código inválido! Usa un link compartido por el admin.");
                return;
            }

            document.getElementById("current-room").textContent = roomCode;
            document.getElementById("login").style.display = "none";
            document.getElementById("chat-ui").style.display = "block";
            
            peerConnection = new RTCPeerConnection(config);
            
            peerConnection.ondatachannel = (event) => {
                dataChannel = event.channel;
                dataChannel.onmessage = (event) => {
                    addMessage("Admin", event.data);
                };
            };

            await peerConnection.setRemoteDescription(JSON.parse(decodeURIComponent(offer)));
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            
            // Enviar respuesta al admin (simplificado para demo)
            alert("Envía esta respuesta al admin: " + JSON.stringify(answer));
        }

        // 3. Enviar mensajes
        function sendMessage() {
            const message = document.getElementById("message-input").value;
            if (message && dataChannel) {
                dataChannel.send(message);
                addMessage(isAdmin ? "Tú (Admin)" : "Tú", message);
                document.getElementById("message-input").value = "";
            }
        }

        // 4. Enviar archivos (hasta 50MB)
        function shareFile() {
            document.getElementById("file-input").click();
        }

        document.getElementById("file-input").onchange = (e) => {
            const file = e.target.files[0];
            if (file.size > 50_000_000) {
                alert("¡Archivo demasiado grande! Máximo 50MB.");
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (event) => {
                dataChannel.send(event.target.result);
                addMessage(isAdmin ? "Tú (Admin)" : "Tú", `📁 ${file.name} (${(file.size / 1024 / 1024).toFixed(2)}MB)`);
            };
            reader.readAsDataURL(file);
        };

        // Helpers
        function addMessage(sender, text) {
            const messagesDiv = document.getElementById("messages");
            const messageClass = sender.includes("Admin") ? "admin-message" : "message";
            messagesDiv.innerHTML += `<div class="${messageClass}"><strong>${sender}:</strong> ${text}</div>`;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Auto-unirse si hay código en la URL
        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('offer')) {
                document.getElementById("room-code").value = urlParams.get('code');
                joinRoom();
            }
        };
    </script>
</body>
</html>