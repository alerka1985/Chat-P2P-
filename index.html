<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat P2P Funcional</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        #login, #chat-admin, #chat-invitado, #esperando {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        #login { display: block; }
        #chat-admin, #chat-invitado, #esperando { display: none; }
        #messages {
            height: 300px;
            border: 1px solid #ddd;
            overflow-y: auto;
            padding: 10px;
            margin: 10px 0;
        }
        .btn {
            padding: 8px 15px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            margin: 5px;
            cursor: pointer;
        }
        .btn-share {
            background: #25D366; /* WhatsApp verde */
        }
        .btn-fb {
            background: #3b5998; /* Facebook azul */
        }
    </style>
</head>
<body>
    <!-- Pantalla inicial -->
    <div id="login">
        <h1>Chat P2P Directo</h1>
        <button class="btn" onclick="iniciarComoAdmin()">Crear Chat</button>
        <div style="text-align: center; margin: 15px 0;">ó</div>
        <input type="text" id="codigo-entrada" placeholder="Código del chat">
        <button class="btn" onclick="unirseComoInvitado()">Unirse</button>
    </div>

    <!-- Chat del Admin -->
    <div id="chat-admin">
        <h2>Admin - Sala: <span id="codigo-admin"></span></h2>
        <div id="admin-messages"></div>
        <input type="text" id="admin-input" placeholder="Escribe tu mensaje">
        <button class="btn" onclick="enviarMensajeAdmin()">Enviar</button>
    </div>

    <!-- Chat del Invitado -->
    <div id="chat-invitado">
        <h2>Invitado - Sala: <span id="codigo-invitado"></span></h2>
        <div id="invitado-messages"></div>
        <input type="text" id="invitado-input" placeholder="Escribe tu mensaje">
        <button class="btn" onclick="enviarMensajeInvitado()">Enviar</button>
    </div>

    <!-- Esperando conexión -->
    <div id="esperando">
        <h2>Conectando a la sala...</h2>
        <p id="info-conexion"></p>
    </div>

    <script>
        // Configuración WebRTC
        const config = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };
        let peerConnection, dataChannel, codigoSala, esAdmin = false;

        // ======================
        // 1. Lógica del Admin
        // ======================
        async function iniciarComoAdmin() {
            esAdmin = true;
            codigoSala = Math.random().toString(36).substring(2, 6).toUpperCase();
            
            // Configurar conexión WebRTC
            peerConnection = new RTCPeerConnection(config);
            dataChannel = peerConnection.createDataChannel("chat");
            
            // Escuchar mensajes del invitado
            dataChannel.onmessage = (event) => {
                agregarMensaje("Invitado", event.data, 'admin');
            };

            // Crear oferta de conexión
            const oferta = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(oferta);
            
            // Mostrar interfaz
            document.getElementById('login').style.display = 'none';
            document.getElementById('chat-admin').style.display = 'block';
            document.getElementById('codigo-admin').textContent = codigoSala;
            
            // Guardar oferta para compartir
            localStorage.setItem('ofertaAdmin', JSON.stringify(oferta));
            alert(`Código para compartir: ${codigoSala}\n\nOferta WebRTC (cópiala):\n${JSON.stringify(oferta)}`);
        }

        function enviarMensajeAdmin() {
            const mensaje = document.getElementById('admin-input').value;
            if (mensaje && dataChannel) {
                dataChannel.send(mensaje);
                agregarMensaje("Tú (Admin)", mensaje, 'admin');
                document.getElementById('admin-input').value = '';
            }
        }

        // ======================
        // 2. Lógica del Invitado
        // ======================
        async function unirseComoInvitado() {
            codigoSala = document.getElementById('codigo-entrada').value.toUpperCase();
            if (!codigoSala) return alert("Ingresa un código válido");
            
            // Mostrar pantalla de espera
            document.getElementById('login').style.display = 'none';
            document.getElementById('esperando').style.display = 'block';
            document.getElementById('info-conexion').textContent = `Sala: ${codigoSala}`;
            
            // Pedir la oferta WebRTC del admin
            const ofertaAdmin = prompt("Pega la oferta WebRTC que te envió el admin:");
            if (!ofertaAdmin) return;
            
            try {
                // Configurar conexión
                peerConnection = new RTCPeerConnection(config);
                
                // Escuchar canal de datos
                peerConnection.ondatachannel = (event) => {
                    dataChannel = event.channel;
                    dataChannel.onmessage = (event) => {
                        agregarMensaje("Admin", event.data, 'invitado');
                    };
                };
                
                // Procesar oferta del admin
                await peerConnection.setRemoteDescription(JSON.parse(ofertaAdmin));
                const respuesta = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(respuesta);
                
                // Mostrar chat
                document.getElementById('esperando').style.display = 'none';
                document.getElementById('chat-invitado').style.display = 'block';
                document.getElementById('codigo-invitado').textContent = codigoSala;
                
                alert("Envía esta respuesta al admin:\n" + JSON.stringify(respuesta));
            } catch (error) {
                alert("Error de conexión: " + error.message);
            }
        }

        function enviarMensajeInvitado() {
            const mensaje = document.getElementById('invitado-input').value;
            if (mensaje && dataChannel) {
                dataChannel.send(mensaje);
                agregarMensaje("Tú", mensaje, 'invitado');
                document.getElementById('invitado-input').value = '';
            }
        }

        // ======================
        // 3. Funciones Comunes
        // ======================
        function agregarMensaje(remitente, texto, tipoChat) {
            const contenedor = tipoChat === 'admin' ? 
                document.getElementById('admin-messages') : 
                document.getElementById('invitado-messages');
                
            contenedor.innerHTML += `<p><strong>${remitente}:</strong> ${texto}</p>`;
            contenedor.scrollTop = contenedor.scrollHeight;
        }

        // Auto-reconexión si hay código en la URL
        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('room')) {
                document.getElementById('codigo-entrada').value = urlParams.get('room');
            }
        };
    </script>
</body>
    </html>
